# SPDX-License-Identifier: Apache-2.0
# Copyright: Derivative work of Alacritty (https://github.com/alacritty/alacritty)
#

diff --git a/alacritty/Cargo.toml b/alacritty/Cargo.toml
index 37996c29..84836879 100644
--- a/alacritty/Cargo.toml
+++ b/alacritty/Cargo.toml
@@ -69,6 +69,9 @@ objc2-app-kit = { version = "0.3.1", default-features = false, features = [
     "NSResponder",
     "NSView",
     "NSWindow",
+    "NSApplication",
+    "NSMenu",
+    "NSMenuItem",
 ] }
 
 [target.'cfg(windows)'.dependencies]
diff --git a/alacritty/src/macos/mod.rs b/alacritty/src/macos/mod.rs
index 90d0fb96..0a3e33e1 100644
--- a/alacritty/src/macos/mod.rs
+++ b/alacritty/src/macos/mod.rs
@@ -14,3 +14,123 @@ pub fn disable_autofill() {
         );
     }
 }
+
+// Implement dock menu using Objective-C runtime
+pub fn setup_dock_menu() {
+    use objc2::ffi::{class_addMethod, object_getClass};
+    use objc2::ffi::sel_registerName;
+    use objc2::{class, msg_send};
+    use std::ffi::CString;
+
+    unsafe {
+        eprintln!("[Alacritty] Setting up dock menu...");
+
+        // Get NSApplication
+        let ns_app_class = class!(NSApplication);
+        let app: *mut AnyObject = msg_send![ns_app_class, sharedApplication];
+
+        // Get the current delegate (set by Winit)
+        let delegate: *mut AnyObject = msg_send![app, delegate];
+
+        if delegate.is_null() {
+            eprintln!("[Alacritty] No delegate found");
+            return;
+        }
+
+        // Get the class of the existing delegate
+        let delegate_class = object_getClass(delegate.cast());
+
+        // Add applicationDockMenu: method to the existing delegate class
+        let method_name = CString::new("applicationDockMenu:").unwrap();
+        let sel = sel_registerName(method_name.as_ptr())
+            .expect("Failed to register selector");
+
+        // Method signature: id (self, SEL, id)
+        let types = CString::new("@@:@").unwrap();
+
+        let success = class_addMethod(
+            delegate_class.cast_mut(),
+            sel,
+            std::mem::transmute(application_dock_menu_impl as *const ()),
+            types.as_ptr(),
+        );
+
+        if success.into() {
+            eprintln!("[Alacritty] Dock menu method added successfully!");
+        } else {
+            eprintln!("[Alacritty] Failed to add dock menu method (may already exist)");
+        }
+    }
+}
+
+// C function that implements applicationDockMenu:
+extern "C" fn application_dock_menu_impl(
+    _self: *mut AnyObject,
+    _cmd: *const std::os::raw::c_void,
+    _app: *mut AnyObject,
+) -> *mut AnyObject {
+    use objc2::{class, msg_send, sel};
+
+    unsafe {
+        eprintln!("[Alacritty] applicationDockMenu: called!");
+
+        // Get NSApplication to access windows
+        let ns_app_class = class!(NSApplication);
+        let app: *mut AnyObject = msg_send![ns_app_class, sharedApplication];
+
+        // Create menu
+        let ns_menu_class = class!(NSMenu);
+        let menu: *mut AnyObject = msg_send![ns_menu_class, alloc];
+        let menu: *mut AnyObject = msg_send![menu, init];
+
+        // Get windows array
+        let windows: *mut AnyObject = msg_send![app, windows];
+        let count: usize = msg_send![windows, count];
+
+        eprintln!("[Alacritty] Found {} windows", count);
+
+        // Add each window to menu
+        for i in 0..count {
+            let window: *mut AnyObject = msg_send![windows, objectAtIndex: i];
+            let title: *mut AnyObject = msg_send![window, title];
+
+            // Check if title is not empty
+            let length: usize = msg_send![title, length];
+            if length > 0 {
+                // Create menu item
+                let ns_menu_item_class = class!(NSMenuItem);
+                let item: *mut AnyObject = msg_send![ns_menu_item_class, alloc];
+                let item: *mut AnyObject = msg_send![item, init];
+
+                let _: () = msg_send![item, setTitle: title];
+                let _: () = msg_send![item, setTarget: window];
+
+                let selector = sel!(makeKeyAndOrderFront:);
+                let _: () = msg_send![item, setAction: selector];
+
+                let _: () = msg_send![menu, addItem: item];
+
+                eprintln!("[Alacritty] Added window to menu");
+            }
+        }
+
+        // Add separator if we have windows
+        if count > 0 {
+            let separator_class = class!(NSMenuItem);
+            let separator: *mut AnyObject = msg_send![separator_class, separatorItem];
+            let _: () = msg_send![menu, addItem: separator];
+        }
+
+        // Add "New Window" item
+        let ns_menu_item_class = class!(NSMenuItem);
+        let new_item: *mut AnyObject = msg_send![ns_menu_item_class, alloc];
+        let new_item: *mut AnyObject = msg_send![new_item, init];
+
+        let new_window_title = ns_string!("New Window");
+        let _: () = msg_send![new_item, setTitle: new_window_title];
+        let _: () = msg_send![menu, addItem: new_item];
+
+        eprintln!("[Alacritty] Dock menu created successfully");
+        menu
+    }
+}
diff --git a/alacritty/src/main.rs b/alacritty/src/main.rs
index 54de44bc..3c7b6363 100644
--- a/alacritty/src/main.rs
+++ b/alacritty/src/main.rs
@@ -183,6 +183,9 @@ fn alacritty(mut options: Options) -> Result<(), Box<dyn Error>> {
     #[cfg(target_os = "macos")]
     macos::disable_autofill();
 
+    #[cfg(target_os = "macos")]
+    macos::setup_dock_menu();
+
     // Create the IPC socket listener.
     #[cfg(unix)]
     let socket_path = if config.ipc_socket() {
